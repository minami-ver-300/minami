<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KIN計算</title>
  <style>
    body{font-family:system-ui,-apple-system,"Noto Sans JP","Hiragino Kaku Gothic ProN",sans-serif;max-width:760px;margin:24px auto;padding:0 16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin-top:16px}
    label{display:block;margin:8px 0 6px}
    input,button{font-size:16px}
    input{padding:10px 12px;width:100%;max-width:320px}
    button{margin-top:12px;padding:10px 14px;border-radius:10px;border:1px solid #222;background:#222;color:#fff;cursor:pointer}
    .result{font-size:18px;line-height:1.9}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
    .muted{color:#666;font-size:13px;line-height:1.6}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{padding:6px 10px;border:1px solid #ddd;border-radius:999px;background:#fafafa;font-size:13px}
  </style>
</head>
<body>
  <h1>KINナンバー計算</h1>
  <p class="muted">
    このページは「2/29を日数として数えない」方式です（＝2/29と3/1が同じKIN）。
  </p>

  <div class="card">
    <div class="row">
      <div>
        <label for="birth">生年月日</label>
        <input id="birth" type="date" />
        <button id="calc">計算する</button>
      </div>
     
      <div class="pill">表示順：音 → 太陽 → WS → KIN</div>
    </div>
  </div>

  <div class="card">
    <div id="out" class="result">ここに結果が表示されます。</div>
    <div id="check" class="muted" style="margin-top:12px;"></div>
  </div>

<script>
(() => {
  // === 20の太陽の紋章（一般的な並び） ===
  const seals = [
    "赤い龍","白い風","青い夜","黄色い種","赤い蛇",
    "白い世界の橋渡し","青い手","黄色い星","赤い月","白い犬",
    "青い猿","黄色い人","赤い空歩く人","白い魔法使い","青い鷲",
    "黄色い戦士","赤い地球","白い鏡","青い嵐","黄色い太陽"
  ];

  const mod = (n,m)=>((n%m)+m)%m;

  // === 閏日スキップ（2/29を数えない）ユーティリティ ===
  const isLeapYear = (y) => (y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0);

  // 年y未満（= y-1まで）に含まれる閏年の数
  const leapYearsBefore = (y) => {
    const n = y - 1;
    return Math.floor(n/4) - Math.floor(n/100) + Math.floor(n/400);
  };

  // 「2/29を3/1扱い」に変換（これで 2/29 と 3/1 が同じ扱いになる）
  const normalizeDateForSkip = (y,m,d) => {
    if (m === 2 && d === 29) return { y, m: 3, d: 1 };
    return { y, m, d };
  };

  // その日付までに「スキップされた2/29」が何回あるか（＝閏年で 3/1 以降なら+1）
  const skippedLeapDaysUpTo = (y,m,d) => {
    // 2/29 は 3/1 と同じ扱いにする
    const n = normalizeDateForSkip(y,m,d);
    const base = leapYearsBefore(n.y);
    const addThisYear = isLeapYear(n.y) && (n.m > 2 || (n.m === 3 && n.d >= 1));
    return base + (addThisYear ? 1 : 0);
  };

  // UTCの「日」番号（1970-01-01からの経過日数）
  const utcDayNumber = (y,m,d) => {
    const msDay = 24*60*60*1000;
    const t = Date.UTC(y, m-1, d);
    return Math.floor(t / msDay);
  };

  // 閏日スキップ方式の「連続日番号」
  const serialDaySkipLeap = (y,m,d) => {
    // 2/29は3/1に寄せる
    const n = normalizeDateForSkip(y,m,d);
    return utcDayNumber(n.y, n.m, n.d) - skippedLeapDaysUpTo(n.y, n.m, n.d);
  };

  // === KIN計算（閏日スキップ方式） ===
  // 基準：1988/12/18 → KIN24
  const BASE = { y:1988, m:12, d:18, kin:24 };
  const baseSerial = serialDaySkipLeap(BASE.y, BASE.m, BASE.d);

  const kinFromDate = (y,m,d) => {
    const s = serialDaySkipLeap(y,m,d);
    const diff = s - baseSerial;            // 閏日スキップ後の経過日数
    return mod((BASE.kin - 1 + diff), 260) + 1;
  };

  const toneFromKin = kin => mod(kin - 1, 13) + 1;
  const solarFromKin = kin => seals[mod(kin - 1, 20)];

  // WS：13日ブロック起点KINの太陽紋章
  const waveSpellFromKin = kin => {
    const startKin = kin - mod(kin - 1, 13);
    return { startKin, name: seals[mod(startKin - 1, 20)] };
  };

  const render = (kin) => {
    const tone = toneFromKin(kin);
    const solar = solarFromKin(kin);
    const ws = waveSpellFromKin(kin);
    // 表示順：音→太陽→WS→KIN
    return `
      音：<code>${tone}</code><br/>
      太陽の紋章：<code>${solar}</code><br/>
      ウェイブスペル：<code>${ws.name}</code>（起点KIN <code>${ws.startKin}</code>）<br/>
      KIN：<code>${kin}</code>
    `;
  };

  // 入力ボタン
  document.getElementById("calc").addEventListener("click", () => {
    const v = document.getElementById("birth").value;
    if (!v) { document.getElementById("out").textContent = "生年月日を選んでください。"; return; }
    const [yy, mm, dd] = v.split("-").map(Number);
    const kin = kinFromDate(yy, mm, dd);
    document.getElementById("out").innerHTML = render(kin);
  });

  // 検算（君が挙げた日付＋2/29挙動チェック）

  document.getElementById("check").innerHTML = tests.map(([label,y,m,d,note])=>{
    const kin = kinFromDate(y,m,d);
    const tone = toneFromKin(kin);
    const solar = solarFromKin(kin);
    const ws = waveSpellFromKin(kin).name;
    return `・${label} → 音${tone} ${solar} / WS ${ws} / KIN${kin} <span style="color:#666">（${note}）</span>`;
  }).join("<br/>");
})();
</script>
</body>
</html>
